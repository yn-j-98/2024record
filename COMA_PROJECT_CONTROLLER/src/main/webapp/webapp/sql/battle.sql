CREATE TABLE BATTLE(
	BATTLE_NUM INT PRIMARY KEY,							--크루전 PK
	BATTLE_GYM_NUM INT,									--크루전 참여 암벽장 FK
	BATTLE_REGISTRATION_DATE DATE DEFAULT SYSDATE,		--크루전 등록 날짜
	BATTLE_GAME_DATE DATE DEFAULT NULL,						--크루전 실제 게임 날짜

);
ALTER TABLE BATTLE
DROP CONSTRAINT FK_BATTLE_GYM_NUM;

ALTER TABLE BATTLE
ADD CONSTRAINT FK_BATTLE_GYM_NUM
FOREIGN KEY (BATTLE_GYM_NUM)
REFERENCES GYM(GYM_NUM);
select * from battle;
--크루전 추가 BATTLE_GYM_NUM, BATTLE_GAME_DATE
INSERT INTO BATTLE(BATTLE_NUM,BATTLE_GYM_NUM,BATTLE_GAME_DATE)
VALUES ((SELECT NVL(MAX(BATTLE_NUM),0)+1 FROM BATTLE),1,'2024-09-07')

SELECT
			BATTLE_NUM
			BATTLE_GYM_NUM,
			BATTLE_GAME_DATE
			FROM
				BATTLE
			WHERE
			BATTLE_NUM = 1
			
SELECT
			BATTLE_NUM
			BATTLE_GYM_NUM,
			BATTLE_GAME_DATE
			FROM
				BATTLE B
			JOIN
				GYM G
			ON
				B.BATTLE_GYM_NUM = G.GYM_NUM
			WHERE
			B.BATTLE_GYM_NUM = ?
--(페이지네이션)활성화 되있는 크루전 전체 출력 내림차순(ALL)
SELECT
    RN,
    B.BATTLE_NUM,
    G.GYM_NAME AS BATTLE_GYM_NAME,
    B.BATTLE_REGISTRATION_DATE,
    G.GYM_LOCATION
FROM (
    SELECT 
        B.BATTLE_NUM,
        G.GYM_NAME,
        B.BATTLE_REGISTRATION_DATE,
        G.GYM_LOCATION,
        ROW_NUMBER() OVER (ORDER BY B.BATTLE_NUM DESC) AS RN
    FROM 
        BATTLE B
    JOIN 
        GYM G
    ON 
        B.BATTLE_GYM_NUM = G.GYM_NUM
    JOIN
        BATTLE_RECORD BR
    ON
        B.BATTLE_NUM = BR.BATTLE_RECORD_BATTLE_NUM
    WHERE
        BR.BATTLE_RECORD_MVP_ID IS NULL
)
WHERE RN BETWEEN 1 AND 10


--활성화 되있는 크루전 총 개수
SELECT COUNT(DISTINCT B.BATTLE_NUM) AS BATTLE_TOTAL
FROM
	BATTLE B
JOIN
	BATTLE_RECORD BR
ON
	B.BATTLE_NUM = BR.BATTLE_RECORD_BATTLE_NUM
FROM
	BR.BATTLE_RECORD_MVP_ID IS NULL

-- 내 크루전 찾기
SELECT 
	B.BATTLE_NUM,
	G.GYM_NAME,
	B.BATTLE_GAME_DATE,
	G.GYM_LOCATION
FROM
	BATTLE B
JOIN
	GYM G
ON
	B.BATTLE_GYM_NUM = G.GYM_NUM
JOIN
	BATTLE_RECORD BR
ON
	BR.BATTLE_RECORD_BATTLE_NUM = B.BATTLE_NUM
WHERE
	BR.BATTLE_RECORD_CREW_NUM = ?
	
--해당 암벽장에서 실행된 크루전 전부 출력 BATTLE_GYM_NUM
SELECT
	BATTLE_NUM,
	BATTLE_GYM_NUM,
	BATTLE_GAME_DATE
FROM
	BATTLE B
JOIN
	GYM G
ON
	B.BATTLE_GYM_NUM = G.GYM_NUM
WHERE
	B.BATTLE_GYM_NUM = ?
	
--크루전 최신 4개 출력
SELECT 
    B.BATTLE_NUM,
    B.BATTLE_GYM_NUM,
    B.BATTLE_REGISTRATION_DATE,
    B.BATTLE_GAME_DATE
FROM (
    SELECT 
        B.BATTLE_NUM,
        B.BATTLE_GYM_NUM,
        B.BATTLE_REGISTRATION_DATE,
        B.BATTLE_GAME_DATE
    FROM 
        BATTLE B
    ORDER BY 
        BATTLE_NUM DESC
) B
WHERE ROWNUM <= 4

-- 게임날짜 업데이트 BATTLE_GAME_DATE, BATTLE_NUM
UPDATE BATTLE SET BATTLE_GAME_DATE = ? WHERE BATTLE_NUM = ?

select * from battle;
DROP TABLE BATTLE;
